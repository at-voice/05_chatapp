<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>index2_èª²é¡Œãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>

</head>

<body>
    <h1>index2_realtime chat</h1>
    <!-- å…¥åŠ›å ´æ‰€ã‚’ä½œæˆã—ã‚ˆã† -->
    <form>
        <fieldset>
            <legend>ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ç”»é¢</legend>
            <div>
                name: <input type="text" id="name">
            </div>
            <div>
                phrase: <input type="text" id="phrase">
            </div>
            <div>
                comment: <input type="text" id="comment">
            </div>
            <div>
                <button type="button" id="send">send</button>
            </div>
        </fieldset>
    </form>

    <!-- ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›å ´æ‰€ -->
    <ul id="output"></ul>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•°
        function convertTimestampToDatetime(timestamp) {
            const _d = timestamp ? new Date(timestamp * 1000) : new Date();
            const Y = _d.getFullYear();
            const m = (_d.getMonth() + 1).toString().padStart(2, '0');
            const d = _d.getDate().toString().padStart(2, '0');
            const H = _d.getHours().toString().padStart(2, '0');
            const i = _d.getMinutes().toString().padStart(2, '0');
            const s = _d.getSeconds().toString().padStart(2, '0');
            return `${Y}/${m}/${d} ${H}:${i}:${s}`;
        }
    </script>
    <!-- ä»¥ä¸‹ã«firebaseã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚ˆã† -->

    <script type="module">

        // ã“ã“ã‹ã‚‰firebaseã¨ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹ãŸã‚ã®æº–å‚™
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.13.0/firebase-app.js";

        // ğŸ”½ è¿½åŠ  / `9.13.0`ã®éƒ¨åˆ†ã‚’â†‘ã®Firestoreã‹ã‚‰è²¼ã‚Šä»˜ã‘ãŸã‚³ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã‚‹
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            orderBy,
            onSnapshot, //firebaseãŒæŒã£ã¦ã‚‹é–¢æ•°ã‚’å¼•ã£å¼µã£ã¦ãã‚‹
        } from "https://www.gstatic.com/firebasejs/9.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBfUIT5OnuwDz3qRdu8w_FY0JeYR7kj_o8",
            authDomain: "chat-homework-bec24.firebaseapp.com",
            projectId: "chat-homework-bec24",
            storageBucket: "chat-homework-bec24.appspot.com",
            messagingSenderId: "301135684176",
            appId: "1:301135684176:web:14f9cf14c79ec967546755"
        };//gitHubã§ã„ã†ç§˜å¯†éµï¼ˆSSHã¿ãŸã„ãªã‚‚ã®ï¼‰


        const app = initializeApp(firebaseConfig);//

        // ğŸ”½ è¿½åŠ  (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€£æºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰  )
        const db = getFirestore(app);
        // æº–å‚™ã“ã“ã¾ã§ firebaseãŒèª­ã¿è¾¼ã¿ã‚„ã™ã„æ§˜ã«å¤‰ãˆãŸã‚ˆï¼ˆJsonã¿ãŸã„ã«ï¼‰


        // chatapp.html

        $("#send").on("click", function () {
            // é€ä¿¡æ™‚ã«å¿…è¦ãªå‡¦ç†

            const firstname = $("#name").val();
            const comment = $("#comment").val();
            const phrase = $("#phrase").val();


            const postData = {
                name: firstname, //valâ†’è¦ç´ ãªã©ã®valueå€¤ã‚’å–å¾—ã™ã‚‹.nameã‚„textã¯key.
                comment: comment,
                phrase: phrase,
                time: serverTimestamp(), //â˜…serverTimestampâ†’FBã®ä»•æ§˜ã§ç¾åœ¨æ™‚åˆ»ã‚’ã¨ã£ã¦ãã‚‹
            }; //postDataã®å®šæ•°ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å®šæ•°ã€‚ä»¥é™å‡ºã¦ãã¦ã‚‚postDataã®ä¸­èº«ã¯ã„ã˜ã‚Œãªã„ã€‚
            console.log(postData);
            addDoc(collection(db, "chat"), postData); //addDoc(ãƒ©ãƒ³ãƒ€ãƒ ãªIDãŒä»˜ä¸ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ)ã€FBã«ç™»éŒ²ã—ã¦ã„ã‚‹
            $("#text").val(""); //#textã®valueå€¤ã‚’å–å¾—ã™ã‚‹â†’#textã‚’ç©ºã«ã™ã‚‹
            $("#name").val(""); //#nameã‚’ç©ºã«ã™ã‚‹
        });




        // â†“ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ç‚¹ã§ç™ºå‹•ã—ã¦ã‚‹ã‚‚ã®
        // ã€æ™‚é–“é †ã«ä¸¦ã¹ã‚‹ã€‘
        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã®æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹ï¼ˆã“ã“ã§ã¯æ™‚é–“ã®æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆï¼‰
        const q = query(collection(db, "chat"), orderBy("time", "desc"));//timeãƒ‘ãƒ¼ãƒˆã ã‘è¦‹ã¦æœ€æ–°é †ã«ä¸¦ã¹æ›¿ãˆã¦ã£ã¦æŒ‡ç¤ºã‚’FBã«å‡ºã—ã¦
        // ã€å…±é€šç”¨èªã€‘queryâ‡¨timeã¨ã‹nameãã‚Œãã‚Œã«å…¥åŠ›ã•ã‚ŒãŸã‚‚ã®ãŒå…¥ã£ãŸç®±
        // å¤‰æ•°qã®å¼•æ•°ãŒqueryä»¥ä¸‹ï¼†orderBy
        // orderByâ†’ä¸¦ã¹æ›¿ãˆã‚‹
        // å®šæ•°qã«ï¼ä»¥é™ã®å‡¦ç†ã‚’å…¥ã‚ŒãŸã„


        onSnapshot(q, (querySnapshot) => { //ä¸¦ã³æ›¿ãˆãŸçŠ¶æ…‹ã®ã‚‚ã®qã‚’å¤‰æ•°Aã«å…¥ã‚Œã¦ãã ã•ã„
            console.log(querySnapshot.docs);
            //onSnapshot() ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ï¼
            // ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ãŒã“ã“ã¾ã§
            // querySnapshotã¯å‹æ‰‹ã«æ±ºã‚ãŸå¤‰æ•°å
            // 



            // â‘ ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†
            // onSnapshot(collection(db, "chat"), (querySnapshot) => {
            //   console.log(querySnapshot.docs);


            // ä¸Šè¨˜ querySnapshot.docs ã¯éå¸¸ã«è¤‡é›‘ãªå½¢ã¨ãªã£ã¦ãŠã‚Šï¼Œã“ã®ã¾ã¾æ‰±ã†ã“ã¨ã¯é›£ã—ã„ï¼
            // ãã®ãŸã‚ï¼Œå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡ºã—ãŸã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®é…åˆ—ã€ã«å¤‰æ›ã™ã‚‹ï¼
            // â‘¡ã€ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šå‡ºã—ã€‘
            const documents = []; //documentsé…åˆ—ã‚’ä½œã‚‹
            querySnapshot.docs.forEach(function (doc) { //forEachâ†’é…åˆ—ã«ç‰¹åŒ–ã—ãŸãƒ«ãƒ¼ãƒ—æ§‹æ–‡ å„è¦ç´ ã‚’å‡ºåŠ›ã™ã‚‹
                // querysnapshotã®ä¸­ã®docsã®ä¸­ã®å€¤ã ã‘ã‚’1ä»¶ãšã¤forEachã§å‡ºåŠ›ã™ã‚‹
                const document = {
                    id: doc.id, //.id ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ IDï¼ˆåå‰ï¼‰ã‚’å–å¾—ã™ã‚‹ï¼ idâ†’key doc.idâ†’value
                    data: doc.data(), //.data() ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸­èº«ï¼ˆ3 é …ç›®ï¼‰ã‚’å–å¾—ã™ã‚‹ï¼
                }; //ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å®šæ•°ã®åå‰ã‚’documentã¨ã—ã¾ã™
                documents.push(document);
            });

            console.log(documents);


            // ã€ç”»é¢è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¿ã‚°ç”Ÿæˆã€‘

            const htmlElements = [];
            documents.forEach(function (document) {
                htmlElements.push(`
    <li id="${document.id}">
      <p>${document.data.name} at ${document.data.time.seconds}</p>
      <p>${document.data.comment}</p>
    </li>
  `);
                //é…åˆ—htmlElementsã«(ä»¥ä¸‹ã‚’å…¥ã‚Œã‚‹ã‚ˆ
                // `(ãƒãƒƒã‚¯ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)ã§å›²ã‚€ã¨ã€æ”¹è¡ŒãŒå¯èƒ½
            });

            console.log(htmlElements)

            $("#output").html(htmlElements);
            //é…åˆ—ã‚ªãƒ¼ãƒ«ã‚’#outputã«è¡¨ç¤ºã™ã‚‹




            // ã€Enterã‚­ãƒ¼ã§é€ä¿¡ã€‘
            // chatapp.html

            $("#text").on("keydown", function (e) {
                if (e.keyCode === 13) { //Enterã‚­ãƒ¼ã¯13
                    const postData = {
                        name: $("#name").val(),
                        text: $("#text").val(),
                        time: serverTimestamp(),
                    };
                    addDoc(collection(db, "chat"), postData);
                    $("#text").val("");
                }
            });


        });






    </script>



</body>

</html>